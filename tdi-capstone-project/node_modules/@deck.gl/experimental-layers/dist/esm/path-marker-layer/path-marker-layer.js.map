{"version":3,"sources":["../../../src/path-marker-layer/path-marker-layer.js"],"names":["CompositeLayer","COORDINATE_SYSTEM","ScatterplotLayer","PathOutlineLayer","MeshLayer","Arrow2DGeometry","createPathMarkers","getClosestPointOnPolyline","DISTANCE_FOR_MULTI_ARROWS","ARROW_HEAD_SIZE","ARROW_TAIL_WIDTH","DEFAULT_MARKER_LAYER","DEFAULT_MARKER_LAYER_PROPS","mesh","headSize","tailWidth","defaultProps","Object","assign","MarkerLayer","markerLayerProps","sizeScale","fp64","hightlightIndex","highlightPoint","getPath","x","path","getColor","color","getMarkerColor","getDirection","direction","getMarkerPercentages","object","lineLength","PathMarkerLayer","state","markers","closestPoint","xyz","viewport","coordinateSystem","coordinateOrigin","METER_OFFSETS","metersToLngLatDelta","dx","dy","y","projectFlat","LNGLAT_OFFSETS","props","oldProps","changeFlags","dataChanged","updateTriggersChanged","data","context","o","_recalculateClosestPoint","propsChanged","point","highlightIndex","points","p","closestPoints","position","info","getSubLayerProps","id","pickable","parameters","blend","depthTest","layerName"],"mappings":"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","sourcesContent":["import {CompositeLayer, COORDINATE_SYSTEM} from '@deck.gl/core';\nimport {ScatterplotLayer} from '@deck.gl/layers';\nimport PathOutlineLayer from '../path-outline-layer/path-outline-layer';\nimport MeshLayer from '../mesh-layer/mesh-layer';\nimport Arrow2DGeometry from './arrow-2d-geometry';\n\nimport createPathMarkers from './create-path-markers';\nimport {getClosestPointOnPolyline} from './polyline';\n\nconst DISTANCE_FOR_MULTI_ARROWS = 0.1;\nconst ARROW_HEAD_SIZE = 0.2;\nconst ARROW_TAIL_WIDTH = 0.05;\n// const ARROW_CENTER_ADJUST = -0.8;\n\nconst DEFAULT_MARKER_LAYER = MeshLayer;\n\nconst DEFAULT_MARKER_LAYER_PROPS = {\n  mesh: new Arrow2DGeometry({headSize: ARROW_HEAD_SIZE, tailWidth: ARROW_TAIL_WIDTH})\n};\n\nconst defaultProps = Object.assign({}, PathOutlineLayer.defaultProps, {\n  MarkerLayer: DEFAULT_MARKER_LAYER,\n  markerLayerProps: DEFAULT_MARKER_LAYER_PROPS,\n\n  sizeScale: 100,\n  fp64: false,\n\n  hightlightIndex: -1,\n  highlightPoint: null,\n\n  getPath: x => x.path,\n  getColor: x => x.color,\n  getMarkerColor: x => [0, 0, 0, 255],\n  getDirection: x => x.direction,\n  getMarkerPercentages: (object, {lineLength}) =>\n    lineLength > DISTANCE_FOR_MULTI_ARROWS ? [0.25, 0.5, 0.75] : [0.5]\n});\n\nexport default class PathMarkerLayer extends CompositeLayer {\n  initializeState() {\n    this.state = {\n      markers: [],\n      mesh: new Arrow2DGeometry({headSize: ARROW_HEAD_SIZE, tailWidth: ARROW_TAIL_WIDTH}),\n      closestPoint: null\n    };\n  }\n\n  projectFlat(xyz, viewport, coordinateSystem, coordinateOrigin) {\n    if (coordinateSystem === COORDINATE_SYSTEM.METER_OFFSETS) {\n      const [dx, dy] = viewport.metersToLngLatDelta(xyz);\n      const [x, y] = coordinateOrigin;\n      return viewport.projectFlat([x + dx, dy + y]);\n    } else if (coordinateSystem === COORDINATE_SYSTEM.LNGLAT_OFFSETS) {\n      const [dx, dy] = xyz;\n      const [x, y] = coordinateOrigin;\n      return viewport.projectFlat([x + dx, dy + y]);\n    }\n\n    return viewport.projectFlat(xyz);\n  }\n\n  updateState({props, oldProps, changeFlags}) {\n    if (changeFlags.dataChanged || changeFlags.updateTriggersChanged) {\n      const {\n        data,\n        getPath,\n        getDirection,\n        getMarkerColor,\n        getMarkerPercentages,\n        coordinateSystem,\n        coordinateOrigin\n      } = this.props;\n      const {viewport} = this.context;\n      const projectFlat = o => this.projectFlat(o, viewport, coordinateSystem, coordinateOrigin);\n      this.state.markers = createPathMarkers({\n        data,\n        getPath,\n        getDirection,\n        getColor: getMarkerColor,\n        getMarkerPercentages,\n        projectFlat\n      });\n      this._recalculateClosestPoint();\n    }\n    if (changeFlags.propsChanged) {\n      if (props.point !== oldProps.point) {\n        this._recalculateClosestPoint();\n      }\n    }\n  }\n\n  _recalculateClosestPoint() {\n    const {highlightPoint, highlightIndex} = this.props;\n    if (highlightPoint && highlightIndex >= 0) {\n      const object = this.props.data[highlightIndex];\n      const points = this.props.getPath(object);\n      const {point} = getClosestPointOnPolyline({points, p: highlightPoint});\n      this.state.closestPoints = [\n        {\n          position: point\n        }\n      ];\n    } else {\n      this.state.closestPoints = [];\n    }\n  }\n\n  getPickingInfo({info}) {\n    return Object.assign(info, {\n      // override object with picked feature\n      object: (info.object && info.object.path) || info.object\n    });\n  }\n\n  renderLayers() {\n    return [\n      new PathOutlineLayer(\n        this.props,\n        this.getSubLayerProps({\n          id: 'paths',\n          // Note: data has to be passed explicitly like this to avoid being empty\n          data: this.props.data\n        })\n      ),\n      new this.props.MarkerLayer(\n        this.getSubLayerProps(\n          Object.assign({}, this.props.markerLayerProps, {\n            id: 'markers',\n            data: this.state.markers,\n            sizeScale: this.props.sizeScale,\n            fp64: this.props.fp64,\n            pickable: false,\n            parameters: {\n              blend: false,\n              depthTest: false\n            }\n          })\n        )\n      ),\n      this.state.closestPoints &&\n        new ScatterplotLayer({\n          id: `${this.props.id}-highlight`,\n          data: this.state.closestPoints,\n          fp64: this.props.fp64\n        })\n    ];\n  }\n}\n\nPathMarkerLayer.layerName = 'PathMarkerLayer';\nPathMarkerLayer.defaultProps = defaultProps;\n"],"file":"path-marker-layer.js"}