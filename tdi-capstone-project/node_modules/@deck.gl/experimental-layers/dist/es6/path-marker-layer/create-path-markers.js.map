{"version":3,"sources":["../../../src/path-marker-layer/create-path-markers.js"],"names":["Vector2","getLineLength","vPoints","lineLength","i","length","distance","DEFAULT_COLOR","DEFAULT_DIRECTION","forward","backward","createPathMarkers","data","getPath","x","path","getDirection","direction","getColor","getMarkerPercentages","projectFlat","markers","object","color","map","p","vPointsReverse","slice","reverse","percentages","percentage","marker","createMarkerAlongPath","push","distanceAlong","currentDistance","previousDistance","vDirection","clone","subtract","normalize","along","vCenter","multiply","add","vDirection2","angle","verticalAngle","Math","PI","position","y"],"mappings":"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","sourcesContent":["import {Vector2} from 'math.gl';\n\nfunction getLineLength(vPoints) {\n  // calculate total length\n  let lineLength = 0;\n  for (let i = 0; i < vPoints.length - 1; i++) {\n    lineLength += vPoints[i].distance(vPoints[i + 1]);\n  }\n  return lineLength;\n}\n\nconst DEFAULT_COLOR = [0, 0, 0, 255];\nconst DEFAULT_DIRECTION = {forward: true, backward: false};\n\nexport default function createPathMarkers({\n  data,\n  getPath = x => x.path,\n  getDirection = x => x.direction,\n  getColor = x => DEFAULT_COLOR,\n  getMarkerPercentages = x => [0.5],\n  projectFlat\n}) {\n  const markers = [];\n\n  for (const object of data) {\n    const path = getPath(object);\n    const direction = getDirection(object) || DEFAULT_DIRECTION;\n    const color = getColor(object);\n\n    const vPoints = path.map(p => new Vector2(p));\n    const vPointsReverse = vPoints.slice(0).reverse();\n\n    // calculate total length\n    const lineLength = getLineLength(vPoints);\n\n    // Ask for where to put markers\n    const percentages = getMarkerPercentages(object, {lineLength});\n\n    // Create the markers\n    for (const percentage of percentages) {\n      if (direction.forward) {\n        const marker = createMarkerAlongPath({\n          path: vPoints,\n          percentage,\n          lineLength,\n          color,\n          object,\n          projectFlat\n        });\n        markers.push(marker);\n      }\n\n      if (direction.backward) {\n        const marker = createMarkerAlongPath({\n          path: vPointsReverse,\n          percentage,\n          lineLength,\n          color,\n          object,\n          projectFlat\n        });\n        markers.push(marker);\n      }\n    }\n  }\n\n  return markers;\n}\n\nfunction createMarkerAlongPath({path, percentage, lineLength, color, object, projectFlat}) {\n  const distanceAlong = lineLength * percentage;\n  let currentDistance = 0;\n  let previousDistance = 0;\n  let i = 0;\n  for (i = 0; i < path.length - 1; i++) {\n    currentDistance += path[i].distance(path[i + 1]);\n    if (currentDistance > distanceAlong) {\n      break;\n    }\n    previousDistance = currentDistance;\n  }\n\n  const vDirection = path[i + 1]\n    .clone()\n    .subtract(path[i])\n    .normalize();\n  const along = distanceAlong - previousDistance;\n  const vCenter = vDirection\n    .clone()\n    .multiply(new Vector2(along, along))\n    .add(path[i]);\n\n  const vDirection2 = new Vector2(projectFlat(path[i + 1])).subtract(projectFlat(path[i]));\n  const angle = (-vDirection2.verticalAngle() * 180) / Math.PI;\n\n  return {position: [vCenter.x, vCenter.y, 0], angle, color, object};\n}\n"],"file":"create-path-markers.js"}