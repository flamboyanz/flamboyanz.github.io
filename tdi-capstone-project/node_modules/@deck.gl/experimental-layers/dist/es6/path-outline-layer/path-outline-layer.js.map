{"version":3,"sources":["../../../src/path-outline-layer/path-outline-layer.js"],"names":["PathLayer","GL","Framebuffer","Texture2D","outline","injectShaderCode","source","declarations","code","INJECT_DECLARATIONS","INJECT_CODE","replace","concat","VS_DECLARATIONS","VS_CODE","FS_CODE","defaultProps","getZLevel","type","value","PathOutlineLayer","getShaders","shaders","Object","assign","modules","vs","fs","initializeState","context","setState","outlineFramebuffer","gl","dummyTexture","state","attributeManager","addInstanced","instanceZLevel","size","UNSIGNED_BYTE","update","calculateZLevels","accessor","draw","moduleParameters","parameters","uniforms","props","rounded","miterLimit","widthScale","widthMinPixels","widthMaxPixels","dashJustified","jointType","Number","alignMode","resize","clear","color","depth","model","updateModuleSettings","outlineEnabled","outlineRenderShadowmap","outlineShadowmap","depthTest","blendEquation","MAX","framebuffer","attribute","pathTesselator","_updateAttribute","target","getValue","object","index","layerName"],"mappings":"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","sourcesContent":["import {PathLayer} from '@deck.gl/layers';\nimport GL from 'luma.gl/constants';\nimport {Framebuffer, Texture2D} from 'luma.gl';\nimport outline from '../shaderlib/outline/outline';\n\n// TODO - this should be built into assembleShaders\nfunction injectShaderCode({source, declarations = '', code = ''}) {\n  const INJECT_DECLARATIONS = /^/;\n  const INJECT_CODE = /}[^{}]*$/;\n\n  return source\n    .replace(INJECT_DECLARATIONS, declarations)\n    .replace(INJECT_CODE, code.concat('\\n}\\n'));\n}\n\nconst VS_DECLARATIONS = `\\\n#ifdef MODULE_OUTLINE\n  attribute float instanceZLevel;\n#endif\n`;\n\nconst VS_CODE = `\\\n#ifdef MODULE_OUTLINE\n  outline_setUV(gl_Position);\n  outline_setZLevel(instanceZLevel);\n#endif\n`;\n\nconst FS_CODE = `\\\n#ifdef MODULE_OUTLINE\n  gl_FragColor = outline_filterColor(gl_FragColor);\n#endif\n`;\n\nconst defaultProps = {\n  getZLevel: {type: 'accessor', value: 0}\n};\n\nexport default class PathOutlineLayer extends PathLayer {\n  // Override getShaders to inject the outline module\n  getShaders() {\n    const shaders = super.getShaders();\n    return Object.assign({}, shaders, {\n      modules: shaders.modules.concat([outline]),\n      vs: injectShaderCode({source: shaders.vs, declarations: VS_DECLARATIONS, code: VS_CODE}),\n      fs: injectShaderCode({source: shaders.fs, code: FS_CODE})\n    });\n  }\n\n  initializeState(context) {\n    super.initializeState(context);\n\n    // Create an outline \"shadow\" map\n    // TODO - we should create a single outlineMap for all layers\n    this.setState({\n      outlineFramebuffer: new Framebuffer(context.gl),\n      dummyTexture: new Texture2D(context.gl)\n    });\n\n    // Create an attribute manager\n    this.state.attributeManager.addInstanced({\n      instanceZLevel: {\n        size: 1,\n        type: GL.UNSIGNED_BYTE,\n        update: this.calculateZLevels,\n        accessor: 'getZLevel'\n      }\n    });\n  }\n\n  // Override draw to add render module\n  draw({moduleParameters = {}, parameters, uniforms, context}) {\n    // Need to calculate same uniforms as base layer\n    const {\n      rounded,\n      miterLimit,\n      widthScale,\n      widthMinPixels,\n      widthMaxPixels,\n      dashJustified\n    } = this.props;\n\n    uniforms = Object.assign({}, uniforms, {\n      jointType: Number(rounded),\n      alignMode: Number(dashJustified),\n      widthScale,\n      miterLimit,\n      widthMinPixels,\n      widthMaxPixels\n    });\n\n    // Render the outline shadowmap (based on segment z orders)\n    const {outlineFramebuffer, dummyTexture} = this.state;\n    outlineFramebuffer.resize();\n    outlineFramebuffer.clear({color: true, depth: true});\n\n    this.state.model.updateModuleSettings({\n      outlineEnabled: true,\n      outlineRenderShadowmap: true,\n      outlineShadowmap: dummyTexture\n    });\n\n    this.state.model.draw({\n      uniforms: Object.assign({}, uniforms, {\n        jointType: 0,\n        widthScale: this.props.widthScale * 1.3\n      }),\n      parameters: {\n        depthTest: false,\n        blendEquation: GL.MAX // Biggest value needs to go into buffer\n      },\n      framebuffer: outlineFramebuffer\n    });\n\n    // Now use the outline shadowmap to render the lines (with outlines)\n    this.state.model.updateModuleSettings({\n      outlineEnabled: true,\n      outlineRenderShadowmap: false,\n      outlineShadowmap: outlineFramebuffer\n    });\n    this.state.model.draw({\n      uniforms: Object.assign({}, uniforms, {\n        jointType: Number(rounded),\n        widthScale: this.props.widthScale\n      }),\n      parameters: {\n        depthTest: false\n      }\n    });\n  }\n\n  calculateZLevels(attribute) {\n    const {getZLevel} = this.props;\n    const {pathTesselator} = this.state;\n\n    attribute.value = pathTesselator._updateAttribute({\n      target: attribute.value,\n      size: 1,\n      getValue: (object, index) => [getZLevel(object, index) || 0]\n    });\n  }\n}\n\nPathOutlineLayer.layerName = 'PathOutlineLayer';\nPathOutlineLayer.defaultProps = defaultProps;\n"],"file":"path-outline-layer.js"}